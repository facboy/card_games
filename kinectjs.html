
<!DOCTYPE HTML>
<html>
<head>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        canvas {
            border: 1px solid #9C9898;
        }
    </style>
    <script src="http://www.html5canvastutorials.com/libraries/kinetic-v3.9.6.js"></script>
    <script>

        var CardGame = {};

        CardGame.CollisionDetection = function(){
            var detector = {}, currentCollision;
            detector.detectCollisionFor = function(gameComponent, components, callback){
                for(var i = 0; i < components.length; i++){
                    var currentComponent = components[i];
                    if(currentComponent !== gameComponent){
                        var c1 = gameComponent.getPoints(), c2 = currentComponent.getPoints();
                        if (c1.bottom >= c2.top && c1.top <= c2.bottom &&
                                c1.right >= c2.left && c1.left <= c2.right){
                            if(currentComponent !== currentCollision){
                                if(currentCollision != null){
                                    currentCollision.onCollisionStop(gameComponent);
                                }
                                currentCollision = currentComponent;
//                                console.log('collision started with '+JSON.stringify(currentCollision.getModel()));
                                currentCollision.onCollisionStart(gameComponent);
                            }
                        }else{
                            if(currentCollision && currentCollision == currentComponent){
//                                console.log('collision stopped with '+JSON.stringify(currentCollision.getModel()));
                                currentCollision.onCollisionStop(gameComponent);
                                currentCollision = null;
                            }
                        }
                    }
                }


            };
            detector.notifyCollisions = function(gameComponent){
                if(currentCollision){
                    currentCollision.onCollisionAccepted(gameComponent);
                }
            };
            return detector;
        };

        CardGame.Stage = function(options){
            var stage = {}, layer = new Kinetic.Layer(),
                    internalStage = new Kinetic.Stage(options),
                    collisionDetection = CardGame.CollisionDetection(),
                    components = [], listeners = {};
            stage.add = function(gameComponent){
                internalStage.add(gameComponent.getComponent());
                components.push(gameComponent);
            };
            stage.detectCollisions = function(gameComponent){
                collisionDetection.detectCollisionFor(gameComponent, components, function(collisionComponent){
                    listeners[collisionComponent] && listeners[collisionComponent]["collisionstart"] &&
                            listeners[collisionComponent]["collisionstart"](gameComponent);
                });
            };
            stage.notifyCollisions = function(gameComponent){
                collisionDetection.notifyCollisions(gameComponent);
            };
            stage.layer = layer;
            stage.on = function(gameComponent, eventType, callback){
                var listenerForComponent = listeners[gameComponent] || {};
                var listenerForEventType = listenerForComponent[eventType] || {};
                listenerForComponent[eventType] = callback;
                listeners[gameComponent] = listenerForComponent;
            };
            return stage;
        };

        CardGame.Card = function(stage, options){
            var card = {}, cardComponent, image,
                    layer = stage.layer,
                    imageObj = new Image(),
            border = new Kinetic.Rect({
                x: 5,
                y: 5,
                width: 82,
                height: 106,
                fill: "#FFFFFF",
                stroke: "#CCCCCC",
                alpha: 0,
                strokeWidth: 2
            });
            cardComponent = new Kinetic.Group({
                x: options.x,
                y: options.y,
                draggable: true
            });
            cardComponent.add(border);
            layer.add(cardComponent);
            imageObj.onload = function() {
                image = new Kinetic.Image({
                    x: 10,
                    y: 10,
                    image: imageObj,
                    width: 72,
                    height: 96,
                    draggable: true
//                    detectionType: "pixel"
                });
                cardComponent.add(image);
                layer.draw();
                cardComponent.on("dragmove", function(){
//                    console.log("dragmove "+JSON.stringify(card.getPoints()));
                    stage.detectCollisions(card);
                });
                cardComponent.on("dragstart", function(){
                    cardComponent.moveToTop();
                });
                cardComponent.on("dragend", function(){
                    console.log('stoppped!');
                    stage.notifyCollisions(card);
                });
                cardComponent.on("click", function(){
                    cardComponent.moveToTop();
                });
                stage.on(card, "collisionstart", function(otherComponent){

                })
            };
            imageObj.src = "cards/classic-cards/"+options.image+".png";

            card.onCollisionStart = function(otherComponent){
                border.setAlpha(1);
            };
            card.onCollisionStop = function(otherComponent){
                border.setAlpha(0);
            };

            card.onCollisionAccepted = function(otherComponent){
                border.setStroke("red");
                layer.draw();
            };
            card.getComponent = function(){
                return layer;
            };
            card.getPoints = function(){
                return {
                    top:cardComponent.getY()+5,
                    left:cardComponent.getX()+5,
                    right:cardComponent.getX()+5 + image.getWidth(),
                    bottom:cardComponent.getY()+5 + image.getHeight()
                };
            };
            card.getModel = function(){
                return { card_id: options.image };
            };
            stage.add(card);
            return card;
        };


        window.onload = function() {
            var stage = CardGame.Stage({
                container: "container",
                width: 800,
                height: 800
            });
            CardGame.Card(stage, {
                x: 10,
                y: 10,
                image: "1"
            });
            CardGame.Card(stage, {
                x: 100,
                y: 10,
                image: "7"
            });
            CardGame.Card(stage, {
                x: 200,
                y: 10,
                image: "17"
            });
            CardGame.Card(stage, {
                x: 300,
                y: 10,
                image: "27"
            });
        };




    </script>
</head>
<body>
<div id="container"></div>
</body>
</html>
