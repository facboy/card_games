
<!DOCTYPE HTML>
<html>
<head>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        canvas {
            border: 1px solid black;
        }
    </style>
    <script type="text/javascript" src="lib/underscore-min.js"></script>
    <script type="text/javascript" src="lib/backbone-min.js"></script>
    <script type="text/javascript" src="lib/kinetic-v3.10.1.min.js"></script>
    <script type="text/javascript" src="src/CardGame.js"></script>
    <script>

        var CardGame = CardGame || {};

        CardGame.Stage = function(ui, options){
            var stage = {}, layer = new Kinetic.Layer(),
                internalStage = new Kinetic.Stage(options),
                collisionDetection = CardGame.CollisionDetection(),
                components = [],
                byZIndex = function (a, b) {
                    return b.getComponent().getZIndex() - a.getComponent().getZIndex();
                },
                remove = function(gameComponent){
                    var ix = components.indexOf(gameComponent);
                    components.splice(ix, 1);
                    layer.remove(gameComponent.getComponent());
                    layer.draw();
                };

            stage.draw = function(){
                layer.draw();
            };

            stage.add = function(gameComponent){
                layer.add(gameComponent.getComponent());
                components.push(gameComponent);
                components.sort(byZIndex);
            };

            stage.remove = function(gameComponent){

            };

            stage.detectCollisions = function(gameComponent){
                collisionDetection.detectCollision(gameComponent, components);
            };

            stage.notifyCurrentCollision = function(gameComponent){
                var destroy = collisionDetection.notifyCurrentCollision(gameComponent);
                if(destroy){
                    remove(gameComponent);
                }
            };

            internalStage.add(layer);

            ui.on("GroupCreated", function(groupId, x, y){
                CardGame.Group(stage, ui, {
                    x: x,
                    y: y,
                    groupId: groupId,
                    cards: []
                });
            });

            ui.on("GroupRemoved", function(groupId){
                for(var i in components){
                    var component = components[i];
                    if(component.getModel().groupId && component.getModel().groupId === groupId){
                        remove(component);
                    }
                }
            });

            return stage;
        };

        CardGame.Collisionable = function(stage, component){
            component.getComponent().on("dragmove", function(){
                stage.detectCollisions(component);
            });
            component.getComponent().on("dragstart", function(){
                component.getComponent().moveToTop();
            });
            component.getComponent().on("dragend", function(){
                stage.notifyCurrentCollision(component);
            });
        };

        CardGame.Group = function(stage, ui, options) {
            var groupId = options.groupId, group = {}, cards = [],
            groupComponent = new Kinetic.Rect({
                x: options.x,
                y: options.y,
                height: 106,
                fill: "#FFFFFF",
                stroke: "#CCCCCC",
                strokeWidth: 2,
                draggable: true
            }),
            // seems a little slow, it seems plausible that it'll actually be faster to group on dragstart and ungroup on dragend
            redrawInternals = function(){
                group.getComponent().setWidth(calculatedWidth(cards.length));
                group.getComponent().setAlpha(calculatedAlpha(cards.length));

                for (var i = 0; i < cards.length; i++) {
                    var card = cards[i].getComponent();
                    card.setX(calculatedX(i, groupComponent.getX()));
                    card.setY(calculatedY(i, groupComponent.getY()));
                    card.moveToTop();
                }
            },
            calculatedX = function(cardIndex, boundingX) {
                return cardIndex * 15 + 5 + boundingX;
            },
            calculatedY = function(cardIndex, boundingY) {
                return 5 + boundingY;
            },
            calculatedWidth = function(cardCount) {
                return 82 + ((cardCount - 1) * 15);
            },
            calculatedAlpha = function(cardCount) {
                return (cards.length > 1 ? 1 : 1);
            },
            removeCard = function(cardComponent){
                var ix = cards.indexOf(cardComponent);
                cards.splice(ix, 1);
                redrawInternals();
            };

            group.getComponent = function(){
                return groupComponent;
            };

            group.onCollisionStart = function(model){
            };

            groupComponent.on("dragmove", function(){
                redrawInternals();
            });

            group.onCollisionStop = function(model){
            };

            group.onCollisionAccepted = function(model){
                console.log("hey group from "+groupId);
            };

            ui.on("CardAdded:"+options.groupId, function(cardId){
                var card = CardGame.Card(stage, ui, {
                    cardId: cardId
                });
                cards.push(card);
                redrawInternals();
            });

            ui.on("CardRemoved:"+options.groupId, function(cardId){
                for(var i = 0; i < cards.length; i++){
                    if(cards[i].getModel().cardId === cardId){
                        removeCard(cards[i]);
                    }
                }
            });

            group.getPoints = function(){
                return {
                    top:groupComponent.getY(),
                    left:groupComponent.getX(),
                    right:groupComponent.getX() + groupComponent.getWidth(),
                    bottom:groupComponent.getY() + groupComponent.getHeight()
                };
            };

            group.getModel = function(){
                return { groupId: groupId };
            };

            CardGame.Collisionable(stage, group);

            stage.add(group);

            return group;
        };

        CardGame.Card = function(stage, ui, options){
            var cardId = options.cardId, card = {},
            imageObj = new Image(),
            image = new Kinetic.Image({
                x: options.x,
                y: options.y,
                width: 72,
                height: 96,
                draggable: true
            });

            imageObj.onload = function() {
                image.setImage(imageObj);
                stage.draw();
            };

            imageObj.src = "cards/classic-cards/"+cardId+".png";

            image.on("dragstart", function(){
                ui.startMoving(cardId);
            });

            card.getComponent = function(){
                return image;
            };

            card.getModel = function(){
                return { cardId: cardId };
            };

            card.getPoints = function () {
                return {
                    top:image.getY(),
                    left:image.getX(),
                    right:image.getX() + image.getWidth(),
                    bottom:image.getY() + image.getHeight()
                };
            };

            card.onCollisionStart = function () {
            };

            card.onCollisionStop = function () {
            };

            card.onCollisionAccepted = function(model){
                if(model.cardId){
                    ui.receiveCard(model.cardId, cardId);
                    return true;
                }
                return false;
            };

            card.onNoCollisionFound = function(){
                ui.droppedOut(cardId, image.getX(), image.getY());
                return true;
            };

            CardGame.Collisionable(stage, card);

            stage.add(card);

            return card;
        };


        window.onload = function() {
            var ui = CardGame.GameUI();
            var stage = CardGame.Stage(ui, {
                container: "container",
                width: 800,
                height: 800
            });

            ui.init([7, 17, 27]);
        };

    </script>
</head>
<body>
<div id="container"></div>
</body>
</html>
