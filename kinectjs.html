
<!DOCTYPE HTML>
<html>
<head>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        canvas {
            border: 1px solid #9C9898;
        }
    </style>
    <script src="http://www.html5canvastutorials.com/libraries/kinetic-v3.9.6.js"></script>
    <script>

        var CardGame = {};

        CardGame.CollisionDetection = function(){
            var detector = {}, currentCollision, checkCollisionBetween, handleCollision, handleNonCollision;

            handleCollision = function(gameComponent, currentComponent){
                if (currentComponent !== currentCollision) {
                    if (currentCollision != null) {
                        currentCollision.onCollisionStop(gameComponent.getModel());
                    }
                    currentCollision = currentComponent;
//                    console.log('collision started with '+JSON.stringify(currentCollision.getModel()));
                    currentCollision.onCollisionStart(gameComponent.getModel());
                }
            };

            handleNonCollision = function(gameComponent, currentComponent){
                if (currentCollision && currentCollision == currentComponent) {
//                    console.log('collision stopped with '+JSON.stringify(currentCollision.getModel()));
                    currentCollision.onCollisionStop(gameComponent.getModel());
                    currentCollision = null;
                }
            };

            checkCollisionBetween = function(gameComponent, currentComponent) {
                if (currentComponent === gameComponent) {
                    return;
                }
                var c1 = gameComponent.getPoints(), c2 = currentComponent.getPoints();
                if (c1.bottom >= c2.top && c1.top <= c2.bottom &&
                        c1.right >= c2.left && c1.left <= c2.right) {
                    handleCollision(gameComponent, currentComponent);
                } else {
                    handleNonCollision(gameComponent, currentComponent);
                }
            };

            detector.detectCollision = function(gameComponent, components){
                for(var i = 0; i < components.length; i++){
                    checkCollisionBetween(gameComponent, components[i]);
                }
            };

            detector.notifyCurrentCollision = function(gameComponent){
                if(currentCollision){
                    currentCollision.onCollisionAccepted(gameComponent);
                }
            };

            return detector;
        };

        CardGame.Stage = function(options){
            var stage = {}, layer = new Kinetic.Layer(),
                    internalStage = new Kinetic.Stage(options),
                    collisionDetection = CardGame.CollisionDetection(),
                    components = [], listeners = {};

            stage.draw = function(){
                layer.draw();
            };

            stage.add = function(gameComponent){
                layer.add(gameComponent.getComponent());
                components.push(gameComponent);
            };

            stage.detectCollisions = function(gameComponent){
                collisionDetection.detectCollision(gameComponent, components);
            };

            stage.notifyCurrentCollision = function(gameComponent){
                collisionDetection.notifyCurrentCollision(gameComponent);
            };

            internalStage.add(layer);

            return stage;
        };

        CardGame.Collisionable = function(stage, component){
            component.getComponent().on("dragmove", function(){
                stage.detectCollisions(component);
            });
            component.getComponent().on("dragstart", function(){
                component.getComponent().moveToTop();
            });
            component.getComponent().on("dragend", function(){
                stage.notifyCurrentCollision(component);
            });
        };

        CardGame.Card = function(stage, options){
            var card = {}, cardComponent, image,
                    layer = stage.layer,
                    imageObj = new Image(),
            border = new Kinetic.Rect({
                x: 5,
                y: 5,
                width: 82,
                height: 106,
                fill: "#FFFFFF",
                stroke: "#CCCCCC",
                alpha: 0,
                strokeWidth: 2
            });
            cardComponent = new Kinetic.Group({
                x: options.x,
                y: options.y,
                draggable: true
            });
            cardComponent.add(border);
            imageObj.onload = function() {
                image = new Kinetic.Image({
                    x: 10,
                    y: 10,
                    image: imageObj,
                    width: 72,
                    height: 96,
                    draggable: true
                });
                cardComponent.add(image);
                stage.draw();
            };

            imageObj.src = "cards/classic-cards/"+options.image+".png";

            cardComponent.on("click", function(){
                cardComponent.moveToTop();
                stage.draw();
            });

            card.onCollisionStart = function(model){
                border.setAlpha(1);
            };

            card.onCollisionStop = function(model){
                border.setAlpha(0);
            };

            card.onCollisionAccepted = function(model){
                border.setStroke("red");
                stage.draw();
            };

            card.getComponent = function(){
                return cardComponent;
            };

            card.getPoints = function(){
                return {
                    top:cardComponent.getY()+5,
                    left:cardComponent.getX()+5,
                    right:cardComponent.getX()+5 + image.getWidth(),
                    bottom:cardComponent.getY()+5 + image.getHeight()
                };
            };

            card.getModel = function(){
                return { card_id: options.image };
            };

            CardGame.Collisionable(stage, card);

            stage.add(card);

            return card;
        };


        window.onload = function() {
            var stage = CardGame.Stage({
                container: "container",
                width: 800,
                height: 800
            });
            CardGame.Card(stage, {
                x: 10,
                y: 10,
                image: "1"
            });
            CardGame.Card(stage, {
                x: 100,
                y: 10,
                image: "7"
            });
            CardGame.Card(stage, {
                x: 120,
                y: 10,
                image: "17"
            });
            CardGame.Card(stage, {
                x: 140,
                y: 10,
                image: "27"
            });
        };




    </script>
</head>
<body>
<div id="container"></div>
</body>
</html>
